IMPORT "directions.bas"
IMPORT "maze.bas"
IMPORT "keycodes.bas"

GENERATE_MAZE()

DISPLAY_MAP = LOAD_RESOURCE("maze.map")
FOR COLUMN=0 TO MAZE_COLUMNS-1
    FOR ROW=0 TO MAZE_ROWS-1
        TEMP=0
        FOR DIR=DIRECTION_FIRST TO DIRECTION_LAST
            IF MAZE_CELL_DOORS(COLUMN,ROW,DIR) THEN
                TEMP=BOR(TEMP,SHL(1,DIR))
            ENDIF
        NEXT DIR
        MSET DISPLAY_MAP,1,COLUMN,ROW,TEMP
    NEXT ROW
NEXT COLUMN

ROOM_ROWS=15
ROOM_COLUMNS=15
PASSAGEWAY_MAPS=LIST()
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY0.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY1.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY2.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY3.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY4.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY5.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY6.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY7.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY8.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY9.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY10.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY11.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY12.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY13.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY14.map"))
PUSH(PASSAGEWAY_MAPS,LOAD_RESOURCE("PASSAGEWAY15.map"))

DUDE_SPRITE = LOAD_RESOURCE("DUDE.sprite")

ATLAS_COLUMN=0
ATLAS_ROW=0
ROOM_COLUMN=7
ROOM_ROW=7


DEF UPDATE(DELTA)
    TEMP=0
    FOR DIR=DIRECTION_FIRST TO DIRECTION_LAST
        IF MAZE_CELL_DOORS(ATLAS_COLUMN,ATLAS_ROW,DIR) THEN
            TEMP=BOR(TEMP,SHL(1,DIR))
        ENDIF
    NEXT DIR
    MAP PASSAGEWAY_MAPS(TEMP),0,0
    SPR DUDE_SPRITE,ROOM_COLUMN*8,ROOM_ROW*8
    IF KEYP CODE_UP THEN
        IF ROOM_ROW>0 THEN 
            ROOM_ROW=ROOM_ROW-1
        ENDIF
        'IF ATLAS_ROW>0 THEN 
        '    ATLAS_ROW=ATLAS_ROW-1
        'ENDIF
    ENDIF
    IF KEYP CODE_DOWN THEN
        IF ROOM_ROW<ROOM_ROWS-1 THEN
            ROOM_ROW=ROOM_ROW+1
        ENDIF
        'IF ATLAS_ROW<MAZE_ROWS-1 THEN
        '    ATLAS_ROW=ATLAS_ROW+1
        'ENDIF
    ENDIF
    IF KEYP CODE_LEFT THEN
        IF ROOM_COLUMN>0 THEN 
            ROOM_COLUMN=ROOM_COLUMN-1
        ENDIF
        'IF ATLAS_COLUMN>0 THEN
        '    ATLAS_COLUMN=ATLAS_COLUMN-1
        'ENDIF
    ENDIF
    IF KEYP CODE_RIGHT THEN
        IF ROOM_COLUMN<ROOM_COLUMNS-1 THEN 
            ROOM_COLUMN=ROOM_COLUMN+1
        ENDIF
        'IF ATLAS_COLUMN<MAZE_COLUMNS-1 THEN
        '    ATLAS_COLUMN=ATLAS_COLUMN+1
        'ENDIF
    ENDIF
ENDDEF

DEF RUN()
    DRV = DRIVER()
    UPDATE_WITH(DRV, CALL(UPDATE))
ENDDEF

